{% if values.isCustomApp %}
name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - '.github/workflows/ci.yaml'  # Ignorar cambios al workflow mismo

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: ${{ values.name }}
  GITOPS_REPO: bcocbo/gitops-apps
  APP_NAME: ${{ values.name }}
  ENVIRONMENT: ${{ values.environment }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: {% raw %}${{ secrets.AWS_ROLE_ARN }}{% endraw %}
          aws-region: {% raw %}${{ env.AWS_REGION }}{% endraw %}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if it doesn't exist
        run: |
          aws ecr describe-repositories --repository-names {% raw %}${{ env.ECR_REPOSITORY }}{% endraw %} --region {% raw %}${{ env.AWS_REGION }}{% endraw %} || \
          aws ecr create-repository \
            --repository-name {% raw %}${{ env.ECR_REPOSITORY }}{% endraw %} \
            --region {% raw %}${{ env.AWS_REGION }}{% endraw %} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256 \
            --tags Key=ManagedBy,Value=Backstage Key=Application,Value={% raw %}${{ env.APP_NAME }}{% endraw %} Key=Environment,Value={% raw %}${{ env.ENVIRONMENT }}{% endraw %}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo {% raw %}${{ github.sha }}{% endraw %} | cut -c1-7)
          IMAGE_TAG="{% raw %}${{ github.ref_name }}{% endraw %}-${SHORT_SHA}-{% raw %}${{ github.run_number }}{% endraw %}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            {% raw %}${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}{% endraw %}
            {% raw %}${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest{% endraw %}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE={% raw %}${{ github.event.head_commit.timestamp }}{% endraw %}
            VCS_REF={% raw %}${{ github.sha }}{% endraw %}

      - name: Update GitOps repository
        env:
          GITHUB_TOKEN: {% raw %}${{ secrets.GITOPS_TOKEN }}{% endraw %}
          IMAGE_TAG: {% raw %}${{ steps.image-tag.outputs.tag }}{% endraw %}
          ECR_REGISTRY: {% raw %}${{ steps.login-ecr.outputs.registry }}{% endraw %}
        run: |
          # Configurar git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Clonar repositorio GitOps
          git clone https://{% raw %}${{ secrets.GITOPS_TOKEN }}{% endraw %}@github.com/{% raw %}${{ env.GITOPS_REPO }}{% endraw %}.git gitops-temp
          cd gitops-temp
          
          # Crear branch para el cambio
          BRANCH_NAME="update-{% raw %}${{ env.APP_NAME }}{% endraw %}-{% raw %}${{ steps.image-tag.outputs.short_sha }}{% endraw %}"
          git checkout -b $BRANCH_NAME
          
          # Actualizar values.yaml
          VALUES_FILE="values/{% raw %}${{ env.ENVIRONMENT }}/${{ env.APP_NAME }}{% endraw %}/values.yaml"
          
          # Instalar yq si no estÃ¡ disponible
          if ! command -v yq &> /dev/null; then
            wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
            chmod +x /usr/local/bin/yq
          fi
          
          # Crear directorio si no existe
          mkdir -p "$(dirname "$VALUES_FILE")"
          
          if [ -f "$VALUES_FILE" ]; then
            echo "ðŸ“ Actualizando values.yaml existente..."
            # Actualizar microservice.image con la imagen completa (repo:tag)
            yq eval ".microservice.image = \"{% raw %}${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}{% endraw %}\"" -i "$VALUES_FILE"
          else
            echo "âš ï¸  Values file no encontrado. DeberÃ­a haber sido creado por Backstage."
            echo "Creando values.yaml bÃ¡sico..."
            cat > "$VALUES_FILE" << EOF
          # Values for {% raw %}${{ env.APP_NAME }}{% endraw %}
          microservice:
            name: "{% raw %}${{ env.APP_NAME }}{% endraw %}"
            namespace: "{% raw %}${{ env.ENVIRONMENT }}{% endraw %}"
            image: "{% raw %}${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}{% endraw %}"
            port: 8000
            replicas: 2
          EOF
          fi
          
          # Commit y push
          git add "$VALUES_FILE"
            git commit -m "chore: Update {% raw %}${{ env.APP_NAME }}{% endraw %} image to {% raw %}${{ env.IMAGE_TAG }}{% endraw %}

            - Image: {% raw %}${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}{% endraw %}
            - Commit: {% raw %}${{ github.sha }}{% endraw %}
            - Branch: {% raw %}${{ github.ref_name }}{% endraw %}
            - Triggered by: {% raw %}${{ github.actor }}{% endraw %}"
            
            git push origin $BRANCH_NAME
            
            # Crear Pull Request usando GitHub CLI
            gh pr create \
              --title "Update {% raw %}${{ env.APP_NAME }}{% endraw %} image to {% raw %}${{ env.IMAGE_TAG }}{% endraw %}" \
              --body "## Image Update

            **Application:** {% raw %}${{ env.APP_NAME }}{% endraw %}
            **Environment:** {% raw %}${{ env.ENVIRONMENT }}{% endraw %}
            **New Image:** \`{% raw %}${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}{% endraw %}\`

            ### Changes
            - Commit: {% raw %}${{ github.sha }}{% endraw %}
            - Branch: {% raw %}${{ github.ref_name }}{% endraw %}
            - Author: {% raw %}${{ github.actor }}{% endraw %}
            - Message: {% raw %}${{ github.event.head_commit.message }}{% endraw %}

            ### Deployment
            Once this PR is merged, ArgoCD will automatically deploy the new image to the \`{% raw %}${{ env.ENVIRONMENT }}{% endraw %}\` environment.

            ---
            ðŸ¤– Automated update from [{% raw %}${{ github.repository }}{% endraw %}]({% raw %}${{ github.event.repository.html_url }}{% endraw %}/commit/{% raw %}${{ github.sha }}{% endraw %})" \
              --base main \
              --head $BRANCH_NAME

      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** {% raw %}${{ env.APP_NAME }}{% endraw %}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** {% raw %}${{ env.ENVIRONMENT }}{% endraw %}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`{% raw %}${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}{% endraw %}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the PR in [gitops-apps](https://github.com/{% raw %}${{ env.GITOPS_REPO }}{% endraw %}/pulls)" >> $GITHUB_STEP_SUMMARY
          echo "2. ArgoCD will automatically deploy the new image" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor the deployment in ArgoCD dashboard" >> $GITHUB_STEP_SUMMARY

{% endif %}
